<color=#75715e>/*-</color>
<color=#75715e> * Copyright (C) 2002, 2017, Oracle and/or its affiliates. All rights reserved.</color>
<color=#75715e> *</color>
<color=#75715e> * This file was distributed by Oracle as part of a version of Oracle Berkeley</color>
<color=#75715e> * DB Java Edition made available at:</color>
<color=#75715e> *</color>
<color=#75715e> * http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html</color>
<color=#75715e> *</color>
<color=#75715e> * Please see the LICENSE file included in the top-level directory of the</color>
<color=#75715e> * appropriate version of Oracle Berkeley DB Java Edition for a copy of the</color>
<color=#75715e> * license and additional information.</color>
<color=#75715e> */</color>

<color=#f92672>package</color> <color=#f8f8f2>com.sleepycat.je.log</color><color=#f8f8f2>;</color>

<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.log.entry.DbOperationType</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.utilint.VLSN</color><color=#f8f8f2>;</color>

<color=#75715e>/**</color>
<color=#75715e> * ReplicationContext provides context about high-level operations so that the logging level can</color>
<color=#75715e> * determine which replication related actions are required for a given Loggable item.</color>
<color=#75715e> *</color>
<color=#75715e> * <p>Those lower level actions are: - does a log entry need to be logged with a VLSN generated by</color>
<color=#75715e> * this (master) node? - does the log entry need to be logged with the VLSN which accompanied a</color>
<color=#75715e> * replication message? - do we need to wait for PERM acks after logging an entry? - do we need to</color>
<color=#75715e> * record the client VLSN that was just written to the log?</color>
<color=#75715e> *</color>
<color=#75715e> * <p>ReplicationContext subclasses may hold additional information about the logical operation</color>
<color=#75715e> * which instigated logging, so that this can be added to the log entry.</color>
<color=#75715e> *</color>
<color=#75715e> * <p>All LogEntryType(s) have a "replicationPossible" attribute. For example, INs will never be</color>
<color=#75715e> * replicated, but LN_TX's may or may not be replicated, depending on whether the owning database is</color>
<color=#75715e> * replicated.</color>
<color=#75715e> *</color>
<color=#75715e> * <p>If a LogEntryType will never be replicated, it should be logged with the static</color>
<color=#75715e> * ReplicationContext.NO_REPLICATE instance. If replication is possible, the replication context may</color>
<color=#75715e> * be: - one allocated for this operation, as the result of client apply - the static instance</color>
<color=#75715e> * MASTER, if this node is the replication master - the static instance NO_REPLICATE, if this is a</color>
<color=#75715e> * local operation</color>
<color=#75715e> */</color>
<color=#66d9ef>public</color> <color=#66d9ef>class</color> <color=#a6e22e>ReplicationContext</color> <color=#f8f8f2>{</color>

  <color=#75715e>/*</color>
<color=#75715e>   * Convenience static instance used when you know this operation is</color>
<color=#75715e>   * executing on a replication master node.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#66d9ef>final</color> <color=#f8f8f2>ReplicationContext</color> <color=#f8f8f2>MASTER</color> <color=#f92672>=</color>
      <color=#66d9ef>new</color> <color=#f8f8f2>ReplicationContext</color><color=#f8f8f2>(</color><color=#66d9ef>true</color> <color=#75715e>/* inReplicationStream */</color><color=#f8f8f2>);</color>

  <color=#75715e>/*</color>
<color=#75715e>   * Convenience static instance used when you know this operation will not</color>
<color=#75715e>   * be replicated, either because it's executing on a non-replicated node,</color>
<color=#75715e>   * it's a local operation for a local database, it's a read only operation,</color>
<color=#75715e>   * or because this loggable item is the type that is never replicated.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#66d9ef>final</color> <color=#f8f8f2>ReplicationContext</color> <color=#f8f8f2>NO_REPLICATE</color> <color=#f92672>=</color>
      <color=#66d9ef>new</color> <color=#f8f8f2>ReplicationContext</color><color=#f8f8f2>(</color><color=#66d9ef>false</color> <color=#75715e>/* inReplicationStream */</color><color=#f8f8f2>);</color>

  <color=#75715e>/*</color>
<color=#75715e>   * If true, this Loggable item is part of the replication stream, and</color>
<color=#75715e>   * needs to be logged with a VLSN.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>final</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>;</color>

  <color=#75715e>/*</color>
<color=#75715e>   * The VLSN value passed in from a replication message directed at</color>
<color=#75715e>   * this replication client.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>final</color> <color=#f8f8f2>VLSN</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>;</color>

  <color=#66d9ef>protected</color> <color=#a6e22e>ReplicationContext</color><color=#f8f8f2>(</color><color=#66d9ef>boolean</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>this</color><color=#f8f8f2>.</color><color=#a6e22e>inReplicationStream</color> <color=#f92672>=</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>;</color>
    <color=#f8f8f2>clientVLSN</color> <color=#f92672>=</color> <color=#66d9ef>null</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/** Used to pass the VLSN held in an arriving message down to the logging levels. */</color>
  <color=#66d9ef>public</color> <color=#a6e22e>ReplicationContext</color><color=#f8f8f2>(</color><color=#f8f8f2>VLSN</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>this</color><color=#f8f8f2>.</color><color=#a6e22e>inReplicationStream</color> <color=#f92672>=</color> <color=#66d9ef>true</color><color=#f8f8f2>;</color>
    <color=#66d9ef>this</color><color=#f8f8f2>.</color><color=#a6e22e>clientVLSN</color> <color=#f92672>=</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/** Used to pass the VLSN held in a migrated LN down to the logging levels. */</color>
  <color=#66d9ef>public</color> <color=#a6e22e>ReplicationContext</color><color=#f8f8f2>(</color><color=#f8f8f2>VLSN</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>,</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>this</color><color=#f8f8f2>.</color><color=#a6e22e>clientVLSN</color> <color=#f92672>=</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>;</color>
    <color=#66d9ef>this</color><color=#f8f8f2>.</color><color=#a6e22e>inReplicationStream</color> <color=#f92672>=</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/**</color>
<color=#75715e>   * @return the VLSN that arrived in the replication message which instigated this Loggable item.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>public</color> <color=#f8f8f2>VLSN</color> <color=#a6e22e>getClientVLSN</color><color=#f8f8f2>()</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>return</color> <color=#f8f8f2>clientVLSN</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/** @return true if this loggable item is part of the replication stream */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>boolean</color> <color=#a6e22e>inReplicationStream</color><color=#f8f8f2>()</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>return</color> <color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/** @return true if this node is the master, and should generate a VLSN for this log entry */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>boolean</color> <color=#a6e22e>mustGenerateVLSN</color><color=#f8f8f2>()</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>return</color> <color=#f8f8f2>(</color><color=#f8f8f2>inReplicationStream</color> <color=#f92672>&&</color> <color=#f8f8f2>(</color><color=#f8f8f2>clientVLSN</color> <color=#f92672>==</color> <color=#66d9ef>null</color><color=#f8f8f2>));</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/**</color>
<color=#75715e>   * @return the type of database operation in progress. For the default case, we return</color>
<color=#75715e>   *     DbOperationType.NONE.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>public</color> <color=#f8f8f2>DbOperationType</color> <color=#a6e22e>getDbOperationType</color><color=#f8f8f2>()</color> <color=#f8f8f2>{</color>
    <color=#66d9ef>return</color> <color=#f8f8f2>DbOperationType</color><color=#f8f8f2>.</color><color=#a6e22e>NONE</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#a6e22e>@Override</color>
  <color=#66d9ef>public</color> <color=#f8f8f2>String</color> <color=#a6e22e>toString</color><color=#f8f8f2>()</color> <color=#f8f8f2>{</color>
    <color=#f8f8f2>StringBuilder</color> <color=#f8f8f2>sb</color> <color=#f92672>=</color> <color=#66d9ef>new</color> <color=#f8f8f2>StringBuilder</color><color=#f8f8f2>();</color>
    <color=#f8f8f2>sb</color><color=#f8f8f2>.</color><color=#a6e22e>append</color><color=#f8f8f2>(</color><color=#e6db74>"inRepStream="</color><color=#f8f8f2>).</color><color=#a6e22e>append</color><color=#f8f8f2>(</color><color=#f8f8f2>inReplicationStream</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>sb</color><color=#f8f8f2>.</color><color=#a6e22e>append</color><color=#f8f8f2>(</color><color=#e6db74>" clientVLSN="</color><color=#f8f8f2>).</color><color=#a6e22e>append</color><color=#f8f8f2>(</color><color=#f8f8f2>clientVLSN</color><color=#f8f8f2>);</color>
    <color=#66d9ef>return</color> <color=#f8f8f2>sb</color><color=#f8f8f2>.</color><color=#a6e22e>toString</color><color=#f8f8f2>();</color>
  <color=#f8f8f2>}</color>
<color=#f8f8f2>}</color>