<color=#75715e>/*-</color>
<color=#75715e> * Copyright (C) 2002, 2017, Oracle and/or its affiliates. All rights reserved.</color>
<color=#75715e> *</color>
<color=#75715e> * This file was distributed by Oracle as part of a version of Oracle Berkeley</color>
<color=#75715e> * DB Java Edition made available at:</color>
<color=#75715e> *</color>
<color=#75715e> * http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html</color>
<color=#75715e> *</color>
<color=#75715e> * Please see the LICENSE file included in the top-level directory of the</color>
<color=#75715e> * appropriate version of Oracle Berkeley DB Java Edition for a copy of the</color>
<color=#75715e> * license and additional information.</color>
<color=#75715e> */</color>

<color=#f92672>package</color> <color=#f8f8f2>com.sleepycat.je.rep.util.ldiff</color><color=#f8f8f2>;</color>

<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.*</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.dbi.CursorImpl</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.log.LogManager</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.log.WholeEntry</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.rep.net.DataChannel</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.rep.util.ldiff.Protocol.RemoteDiffRequest</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.rep.utilint.BinaryProtocol.Message</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.rep.utilint.BinaryProtocol.ProtocolException</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>com.sleepycat.je.utilint.VLSN</color><color=#f8f8f2>;</color>

<color=#f92672>import</color> <color=#f8f8f2>java.util.HashSet</color><color=#f8f8f2>;</color>
<color=#f92672>import</color> <color=#f8f8f2>java.util.List</color><color=#f8f8f2>;</color>

<color=#75715e>/*</color>
<color=#75715e> * Class used for figuring out the difference on local and remote databases,</color>
<color=#75715e> * also getting the VLSN number for different records.</color>
<color=#75715e> *</color>
<color=#75715e> * This class only needs to traverse the local and remote databases once and</color>
<color=#75715e> * do the check, this is because the different areas are sequential on the</color>
<color=#75715e> * database.</color>
<color=#75715e> *</color>
<color=#75715e> * It uses a hash set to save the records on the local different area, and</color>
<color=#75715e> * another hash set to save the records on the remote different area. Then</color>
<color=#75715e> * traverse the records in local set to see whether it exists in the remote</color>
<color=#75715e> * set, and do the same thing on records in remote set.</color>
<color=#75715e> */</color>
<color=#66d9ef>public</color> <color=#66d9ef>class</color> <color=#a6e22e>DiffRecordAnalyzer</color> <color=#f8f8f2>{</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#66d9ef>final</color> <color=#66d9ef>long</color> <color=#f8f8f2>DATABASE_END</color> <color=#f92672>=</color> <color=#f92672>-</color><color=#ae81ff>1</color><color=#f8f8f2>;</color>

  <color=#75715e>/* The analysis method used by network LDiff. */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>doAnalysis</color><color=#f8f8f2>(</color>
      <color=#f8f8f2>Database</color> <color=#f8f8f2>localDb</color><color=#f8f8f2>,</color>
      <color=#f8f8f2>Protocol</color> <color=#f8f8f2>protocol</color><color=#f8f8f2>,</color>
      <color=#f8f8f2>DataChannel</color> <color=#f8f8f2>channel</color><color=#f8f8f2>,</color>
      <color=#f8f8f2>DiffTracker</color> <color=#f8f8f2>tracker</color><color=#f8f8f2>,</color>
      <color=#66d9ef>boolean</color> <color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color>
      <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>List</color><color=#f92672><</color><color=#f8f8f2>MismatchedRegion</color><color=#f92672>></color> <color=#f8f8f2>regions</color> <color=#f92672>=</color> <color=#f8f8f2>tracker</color><color=#f8f8f2>.</color><color=#a6e22e>getDiffRegions</color><color=#f8f8f2>();</color>
    <color=#f8f8f2>Cursor</color> <color=#f8f8f2>localCursor</color> <color=#f92672>=</color> <color=#66d9ef>null</color><color=#f8f8f2>;</color>
    <color=#66d9ef>try</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>localCursor</color> <color=#f92672>=</color> <color=#f8f8f2>localDb</color><color=#f8f8f2>.</color><color=#a6e22e>openCursor</color><color=#f8f8f2>(</color><color=#66d9ef>null</color><color=#f8f8f2>,</color> <color=#66d9ef>null</color><color=#f8f8f2>);</color>

      <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>MismatchedRegion</color> <color=#f8f8f2>region</color> <color=#f8f8f2>:</color> <color=#f8f8f2>regions</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>isLocalAdditional</color><color=#f8f8f2>())</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>printLocalAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>localCursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>region</color><color=#f8f8f2>,</color> <color=#f8f8f2>doPrint</color><color=#f8f8f2>);</color>
          <color=#66d9ef>continue</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>}</color>

        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>isRemoteAdditional</color><color=#f8f8f2>())</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>records</color> <color=#f92672>=</color> <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color><color=#f8f8f2>protocol</color><color=#f8f8f2>,</color> <color=#f8f8f2>channel</color><color=#f8f8f2>,</color> <color=#f8f8f2>region</color><color=#f8f8f2>);</color>
          <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
            <color=#f8f8f2>printAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>records</color><color=#f8f8f2>,</color> <color=#66d9ef>true</color><color=#f8f8f2>);</color>
          <color=#f8f8f2>}</color>
          <color=#f8f8f2>records</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
          <color=#66d9ef>continue</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>}</color>

        <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>localRecords</color> <color=#f92672>=</color>
            <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color>
                <color=#f8f8f2>localCursor</color><color=#f8f8f2>,</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginKey</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginData</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalDiffSize</color><color=#f8f8f2>());</color>
        <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>remoteRecords</color> <color=#f92672>=</color> <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color><color=#f8f8f2>protocol</color><color=#f8f8f2>,</color> <color=#f8f8f2>channel</color><color=#f8f8f2>,</color> <color=#f8f8f2>region</color><color=#f8f8f2>);</color>
        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>printDiffs</color><color=#f8f8f2>(</color><color=#f8f8f2>localRecords</color><color=#f8f8f2>,</color> <color=#f8f8f2>remoteRecords</color><color=#f8f8f2>);</color>
        <color=#f8f8f2>}</color>
        <color=#f8f8f2>localRecords</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
        <color=#f8f8f2>remoteRecords</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color> <color=#66d9ef>finally</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>localCursor</color> <color=#f92672>!=</color> <color=#66d9ef>null</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>localCursor</color><color=#f8f8f2>.</color><color=#a6e22e>close</color><color=#f8f8f2>();</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* The analysis method used by two local databases. */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>doAnalysis</color><color=#f8f8f2>(</color>
      <color=#f8f8f2>Database</color> <color=#f8f8f2>localDb</color><color=#f8f8f2>,</color> <color=#f8f8f2>Database</color> <color=#f8f8f2>remoteDb</color><color=#f8f8f2>,</color> <color=#f8f8f2>DiffTracker</color> <color=#f8f8f2>tracker</color><color=#f8f8f2>,</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>List</color><color=#f92672><</color><color=#f8f8f2>MismatchedRegion</color><color=#f92672>></color> <color=#f8f8f2>regions</color> <color=#f92672>=</color> <color=#f8f8f2>tracker</color><color=#f8f8f2>.</color><color=#a6e22e>getDiffRegions</color><color=#f8f8f2>();</color>
    <color=#f8f8f2>Cursor</color> <color=#f8f8f2>localCursor</color> <color=#f92672>=</color> <color=#66d9ef>null</color><color=#f8f8f2>;</color>
    <color=#f8f8f2>Cursor</color> <color=#f8f8f2>remoteCursor</color> <color=#f92672>=</color> <color=#66d9ef>null</color><color=#f8f8f2>;</color>
    <color=#66d9ef>try</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>localCursor</color> <color=#f92672>=</color> <color=#f8f8f2>localDb</color><color=#f8f8f2>.</color><color=#a6e22e>openCursor</color><color=#f8f8f2>(</color><color=#66d9ef>null</color><color=#f8f8f2>,</color> <color=#66d9ef>null</color><color=#f8f8f2>);</color>
      <color=#f8f8f2>remoteCursor</color> <color=#f92672>=</color> <color=#f8f8f2>remoteDb</color><color=#f8f8f2>.</color><color=#a6e22e>openCursor</color><color=#f8f8f2>(</color><color=#66d9ef>null</color><color=#f8f8f2>,</color> <color=#66d9ef>null</color><color=#f8f8f2>);</color>

      <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>MismatchedRegion</color> <color=#f8f8f2>region</color> <color=#f8f8f2>:</color> <color=#f8f8f2>regions</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>isLocalAdditional</color><color=#f8f8f2>())</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>printLocalAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>localCursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>region</color><color=#f8f8f2>,</color> <color=#f8f8f2>doPrint</color><color=#f8f8f2>);</color>
          <color=#66d9ef>continue</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>}</color>

        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>isRemoteAdditional</color><color=#f8f8f2>())</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>records</color> <color=#f92672>=</color>
              <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color>
                  <color=#f8f8f2>remoteCursor</color><color=#f8f8f2>,</color>
                  <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteBeginKey</color><color=#f8f8f2>(),</color>
                  <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteBeginData</color><color=#f8f8f2>(),</color>
                  <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteDiffSize</color><color=#f8f8f2>());</color>
          <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
            <color=#f8f8f2>printAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>records</color><color=#f8f8f2>,</color> <color=#66d9ef>true</color><color=#f8f8f2>);</color>
          <color=#f8f8f2>}</color>
          <color=#f8f8f2>records</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
          <color=#66d9ef>continue</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>}</color>

        <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>localRecords</color> <color=#f92672>=</color>
            <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color>
                <color=#f8f8f2>localCursor</color><color=#f8f8f2>,</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginKey</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginData</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalDiffSize</color><color=#f8f8f2>());</color>
        <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>remoteRecords</color> <color=#f92672>=</color>
            <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color>
                <color=#f8f8f2>remoteCursor</color><color=#f8f8f2>,</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteBeginKey</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteBeginData</color><color=#f8f8f2>(),</color>
                <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getRemoteDiffSize</color><color=#f8f8f2>());</color>
        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
          <color=#f8f8f2>printDiffs</color><color=#f8f8f2>(</color><color=#f8f8f2>localRecords</color><color=#f8f8f2>,</color> <color=#f8f8f2>remoteRecords</color><color=#f8f8f2>);</color>
        <color=#f8f8f2>}</color>
        <color=#f8f8f2>localRecords</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
        <color=#f8f8f2>remoteRecords</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color> <color=#66d9ef>finally</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>localCursor</color> <color=#f92672>!=</color> <color=#66d9ef>null</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>localCursor</color><color=#f8f8f2>.</color><color=#a6e22e>close</color><color=#f8f8f2>();</color>
      <color=#f8f8f2>}</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>remoteCursor</color> <color=#f92672>!=</color> <color=#66d9ef>null</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>remoteCursor</color><color=#f8f8f2>.</color><color=#a6e22e>close</color><color=#f8f8f2>();</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* Print local additional records. */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>printLocalAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>Cursor</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>MismatchedRegion</color> <color=#f8f8f2>region</color><color=#f8f8f2>,</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color>
      <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>records</color> <color=#f92672>=</color>
        <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color>
            <color=#f8f8f2>cursor</color><color=#f8f8f2>,</color>
            <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginKey</color><color=#f8f8f2>(),</color>
            <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalBeginData</color><color=#f8f8f2>(),</color>
            <color=#f8f8f2>region</color><color=#f8f8f2>.</color><color=#a6e22e>getLocalDiffSize</color><color=#f8f8f2>());</color>
    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>doPrint</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>printAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>records</color><color=#f8f8f2>,</color> <color=#66d9ef>false</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>}</color>
    <color=#f8f8f2>records</color><color=#f8f8f2>.</color><color=#a6e22e>clear</color><color=#f8f8f2>();</color>
  <color=#f8f8f2>}</color>

  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>printAdditional</color><color=#f8f8f2>(</color><color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>diffRecords</color><color=#f8f8f2>,</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>remote</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#f8f8f2>String</color> <color=#f8f8f2>side</color> <color=#f92672>=</color> <color=#f8f8f2>remote</color> <color=#f92672>?</color> <color=#e6db74>"Remote"</color> <color=#f8f8f2>:</color> <color=#e6db74>"Local"</color><color=#f8f8f2>;</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color><color=#e6db74>"************************************************"</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color>
        <color=#f8f8f2>side</color> <color=#f92672>+</color> <color=#e6db74>" database has additional records, the "</color> <color=#f92672>+</color> <color=#e6db74>"additional range as following:"</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>side</color> <color=#f92672>=</color> <color=#f8f8f2>remote</color> <color=#f92672>?</color> <color=#e6db74>"remote"</color> <color=#f8f8f2>:</color> <color=#e6db74>"local"</color><color=#f8f8f2>;</color>
    <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>Record</color> <color=#f8f8f2>record</color> <color=#f8f8f2>:</color> <color=#f8f8f2>diffRecords</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>printRecord</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>,</color> <color=#f8f8f2>side</color><color=#f8f8f2>,</color> <color=#66d9ef>false</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>}</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color><color=#e6db74>"************************************************"</color><color=#f8f8f2>);</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/*</color>
<color=#75715e>   * Print out the VLSN (if this record has) and the key's context of this</color>
<color=#75715e>   * record.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>printRecord</color><color=#f8f8f2>(</color><color=#f8f8f2>Record</color> <color=#f8f8f2>record</color><color=#f8f8f2>,</color> <color=#f8f8f2>String</color> <color=#f8f8f2>side</color><color=#f8f8f2>,</color> <color=#66d9ef>boolean</color> <color=#f8f8f2>different</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#e6db74>"Record with Key: ["</color><color=#f8f8f2>);</color>
    <color=#66d9ef>byte</color><color=#f92672>[]</color> <color=#f8f8f2>keys</color> <color=#f92672>=</color> <color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getKey</color><color=#f8f8f2>();</color>
    <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#66d9ef>int</color> <color=#f8f8f2>i</color> <color=#f92672>=</color> <color=#ae81ff>0</color><color=#f8f8f2>;</color> <color=#f8f8f2>i</color> <color=#f92672><</color> <color=#f8f8f2>keys</color><color=#f8f8f2>.</color><color=#a6e22e>length</color><color=#f8f8f2>;</color> <color=#f8f8f2>i</color><color=#f92672>++</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#f8f8f2>keys</color><color=#f92672>[</color><color=#f8f8f2>i</color><color=#f92672>]</color><color=#f8f8f2>);</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>i</color> <color=#f92672><</color> <color=#f8f8f2>(</color><color=#f8f8f2>keys</color><color=#f8f8f2>.</color><color=#a6e22e>length</color> <color=#f92672>-</color> <color=#ae81ff>1</color><color=#f8f8f2>))</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#e6db74>" "</color><color=#f8f8f2>);</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#e6db74>"]"</color><color=#f8f8f2>);</color>
    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getVLSN</color><color=#f8f8f2>().</color><color=#a6e22e>getSequence</color><color=#f8f8f2>()</color> <color=#f92672>!=</color> <color=#f92672>-</color><color=#ae81ff>1</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#e6db74>", VLSN: "</color> <color=#f92672>+</color> <color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getVLSN</color><color=#f8f8f2>());</color>
    <color=#f8f8f2>}</color>
    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>different</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>print</color><color=#f8f8f2>(</color><color=#e6db74>" does not exist on "</color> <color=#f92672>+</color> <color=#f8f8f2>side</color> <color=#f92672>+</color> <color=#e6db74>" database"</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>}</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>();</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* Return a different area on local database in a hash set. */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#a6e22e>getDiffArea</color><color=#f8f8f2>(</color>
      <color=#f8f8f2>Cursor</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#66d9ef>byte</color><color=#f92672>[]</color> <color=#f8f8f2>beginKey</color><color=#f8f8f2>,</color> <color=#66d9ef>byte</color><color=#f92672>[]</color> <color=#f8f8f2>beginData</color><color=#f8f8f2>,</color> <color=#66d9ef>long</color> <color=#f8f8f2>diffSize</color><color=#f8f8f2>)</color> <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>records</color> <color=#f92672>=</color> <color=#66d9ef>new</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color><color=#f8f8f2>();</color>
    <color=#f8f8f2>LogManager</color> <color=#f8f8f2>logManager</color> <color=#f92672>=</color>
        <color=#f8f8f2>DbInternal</color><color=#f8f8f2>.</color><color=#a6e22e>getNonNullEnvImpl</color><color=#f8f8f2>(</color><color=#f8f8f2>cursor</color><color=#f8f8f2>.</color><color=#a6e22e>getDatabase</color><color=#f8f8f2>().</color><color=#a6e22e>getEnvironment</color><color=#f8f8f2>()).</color><color=#a6e22e>getLogManager</color><color=#f8f8f2>();</color>

    <color=#f8f8f2>DatabaseEntry</color> <color=#f8f8f2>key</color> <color=#f92672>=</color> <color=#66d9ef>new</color> <color=#f8f8f2>DatabaseEntry</color><color=#f8f8f2>(</color><color=#f8f8f2>beginKey</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>DatabaseEntry</color> <color=#f8f8f2>data</color> <color=#f92672>=</color> <color=#66d9ef>new</color> <color=#f8f8f2>DatabaseEntry</color><color=#f8f8f2>(</color><color=#f8f8f2>beginData</color><color=#f8f8f2>);</color>
    <color=#66d9ef>boolean</color> <color=#f8f8f2>scanToEnd</color> <color=#f92672>=</color> <color=#f8f8f2>(</color><color=#f8f8f2>diffSize</color> <color=#f92672>==</color> <color=#f8f8f2>DATABASE_END</color><color=#f8f8f2>);</color>
    <color=#66d9ef>long</color> <color=#f8f8f2>count</color> <color=#f92672>=</color> <color=#ae81ff>1</color><color=#f8f8f2>;</color>

    <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>OperationStatus</color> <color=#f8f8f2>status</color> <color=#f92672>=</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>.</color><color=#a6e22e>getSearchBoth</color><color=#f8f8f2>(</color><color=#f8f8f2>key</color><color=#f8f8f2>,</color> <color=#f8f8f2>data</color><color=#f8f8f2>,</color> <color=#f8f8f2>LockMode</color><color=#f8f8f2>.</color><color=#a6e22e>DEFAULT</color><color=#f8f8f2>);</color>
        <color=#f8f8f2>status</color> <color=#f92672>==</color> <color=#f8f8f2>OperationStatus</color><color=#f8f8f2>.</color><color=#a6e22e>SUCCESS</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>status</color> <color=#f92672>=</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>.</color><color=#a6e22e>getNext</color><color=#f8f8f2>(</color><color=#f8f8f2>key</color><color=#f8f8f2>,</color> <color=#f8f8f2>data</color><color=#f8f8f2>,</color> <color=#f8f8f2>LockMode</color><color=#f8f8f2>.</color><color=#a6e22e>DEFAULT</color><color=#f8f8f2>))</color> <color=#f8f8f2>{</color>

      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f92672>!</color><color=#f8f8f2>scanToEnd</color> <color=#f92672>&&</color> <color=#f8f8f2>count</color> <color=#f92672>></color> <color=#f8f8f2>diffSize</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#66d9ef>break</color><color=#f8f8f2>;</color>
      <color=#f8f8f2>}</color>
      <color=#f8f8f2>records</color><color=#f8f8f2>.</color><color=#a6e22e>add</color><color=#f8f8f2>(</color><color=#66d9ef>new</color> <color=#f8f8f2>Record</color><color=#f8f8f2>(</color><color=#f8f8f2>key</color><color=#f8f8f2>.</color><color=#a6e22e>getData</color><color=#f8f8f2>(),</color> <color=#f8f8f2>data</color><color=#f8f8f2>.</color><color=#a6e22e>getData</color><color=#f8f8f2>(),</color> <color=#f8f8f2>getVLSN</color><color=#f8f8f2>(</color><color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>logManager</color><color=#f8f8f2>)));</color>
      <color=#f8f8f2>count</color><color=#f92672>++</color><color=#f8f8f2>;</color>
    <color=#f8f8f2>}</color>

    <color=#66d9ef>return</color> <color=#f8f8f2>records</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* Used by LDiffService. */</color>
  <color=#66d9ef>public</color> <color=#66d9ef>static</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#a6e22e>getDiffArea</color><color=#f8f8f2>(</color><color=#f8f8f2>Cursor</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>RemoteDiffRequest</color> <color=#f8f8f2>request</color><color=#f8f8f2>)</color>
      <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#66d9ef>return</color> <color=#f8f8f2>getDiffArea</color><color=#f8f8f2>(</color><color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>request</color><color=#f8f8f2>.</color><color=#a6e22e>getKey</color><color=#f8f8f2>(),</color> <color=#f8f8f2>request</color><color=#f8f8f2>.</color><color=#a6e22e>getData</color><color=#f8f8f2>(),</color> <color=#f8f8f2>request</color><color=#f8f8f2>.</color><color=#a6e22e>getDiffSize</color><color=#f8f8f2>());</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* Get the records of a different area on remote database in a HashSet. */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#a6e22e>getDiffArea</color><color=#f8f8f2>(</color>
      <color=#f8f8f2>Protocol</color> <color=#f8f8f2>protocol</color><color=#f8f8f2>,</color> <color=#f8f8f2>DataChannel</color> <color=#f8f8f2>channel</color><color=#f8f8f2>,</color> <color=#f8f8f2>MismatchedRegion</color> <color=#f8f8f2>region</color><color=#f8f8f2>)</color> <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>protocol</color><color=#f8f8f2>.</color><color=#a6e22e>write</color><color=#f8f8f2>(</color><color=#f8f8f2>protocol</color><color=#f8f8f2>.</color><color=#a6e22e>new</color> <color=#a6e22e>RemoteDiffRequest</color><color=#f8f8f2>(</color><color=#f8f8f2>region</color><color=#f8f8f2>),</color> <color=#f8f8f2>channel</color><color=#f8f8f2>);</color>

    <color=#75715e>/* Check whether getting records on remote database is successful. */</color>
    <color=#f8f8f2>Message</color> <color=#f8f8f2>message</color> <color=#f92672>=</color> <color=#f8f8f2>protocol</color><color=#f8f8f2>.</color><color=#a6e22e>read</color><color=#f8f8f2>(</color><color=#f8f8f2>channel</color><color=#f8f8f2>);</color>
    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>message</color><color=#f8f8f2>.</color><color=#a6e22e>getOp</color><color=#f8f8f2>()</color> <color=#f92672>==</color> <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>ERROR</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>throw</color> <color=#66d9ef>new</color> <color=#f8f8f2>LDiffRecordRequestException</color><color=#f8f8f2>(((</color><color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>Error</color><color=#f8f8f2>)</color> <color=#f8f8f2>message</color><color=#f8f8f2>).</color><color=#a6e22e>getErrorMessage</color><color=#f8f8f2>());</color>
    <color=#f8f8f2>}</color>

    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>message</color><color=#f8f8f2>.</color><color=#a6e22e>getOp</color><color=#f8f8f2>()</color> <color=#f92672>!=</color> <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>DIFF_AREA_START</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>throw</color> <color=#66d9ef>new</color> <color=#f8f8f2>ProtocolException</color><color=#f8f8f2>(</color><color=#f8f8f2>message</color><color=#f8f8f2>,</color> <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>DiffAreaStart</color><color=#f8f8f2>.</color><color=#a6e22e>class</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>}</color>

    <color=#75715e>/* Add those different records until protocol sees an end signal. */</color>
    <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>records</color> <color=#f92672>=</color> <color=#66d9ef>new</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color><color=#f8f8f2>();</color>
    <color=#66d9ef>while</color> <color=#f8f8f2>(</color><color=#66d9ef>true</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>try</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>RemoteRecord</color> <color=#f8f8f2>record</color> <color=#f92672>=</color> <color=#f8f8f2>protocol</color><color=#f8f8f2>.</color><color=#a6e22e>read</color><color=#f8f8f2>(</color><color=#f8f8f2>channel</color><color=#f8f8f2>,</color> <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>RemoteRecord</color><color=#f8f8f2>.</color><color=#a6e22e>class</color><color=#f8f8f2>);</color>
        <color=#f8f8f2>records</color><color=#f8f8f2>.</color><color=#a6e22e>add</color><color=#f8f8f2>(</color><color=#66d9ef>new</color> <color=#f8f8f2>Record</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getKey</color><color=#f8f8f2>(),</color> <color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getData</color><color=#f8f8f2>(),</color> <color=#f8f8f2>record</color><color=#f8f8f2>.</color><color=#a6e22e>getVLSN</color><color=#f8f8f2>()));</color>
      <color=#f8f8f2>}</color> <color=#66d9ef>catch</color> <color=#f8f8f2>(</color><color=#f8f8f2>ProtocolException</color> <color=#f8f8f2>pe</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
        <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>pe</color><color=#f8f8f2>.</color><color=#a6e22e>getUnexpectedMessage</color><color=#f8f8f2>().</color><color=#a6e22e>getOp</color><color=#f8f8f2>()</color> <color=#f92672>!=</color> <color=#f8f8f2>Protocol</color><color=#f8f8f2>.</color><color=#a6e22e>DIFF_AREA_END</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
          <color=#66d9ef>throw</color> <color=#f8f8f2>pe</color><color=#f8f8f2>;</color>
        <color=#f8f8f2>}</color>
        <color=#66d9ef>break</color><color=#f8f8f2>;</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>

    <color=#66d9ef>return</color> <color=#f8f8f2>records</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/* Compare the differences between two sets. */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#66d9ef>void</color> <color=#a6e22e>printDiffs</color><color=#f8f8f2>(</color><color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>localDiffs</color><color=#f8f8f2>,</color> <color=#f8f8f2>HashSet</color><color=#f92672><</color><color=#f8f8f2>Record</color><color=#f92672>></color> <color=#f8f8f2>remoteDiffs</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color><color=#e6db74>"************************************************"</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color>
        <color=#e6db74>"Different records between local and remote database "</color> <color=#f92672>+</color> <color=#e6db74>"in a specific different area."</color><color=#f8f8f2>);</color>
    <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>Record</color> <color=#f8f8f2>record</color> <color=#f8f8f2>:</color> <color=#f8f8f2>localDiffs</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f92672>!</color><color=#f8f8f2>remoteDiffs</color><color=#f8f8f2>.</color><color=#a6e22e>contains</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>))</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>printRecord</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>,</color> <color=#e6db74>"remote"</color><color=#f8f8f2>,</color> <color=#66d9ef>true</color><color=#f8f8f2>);</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>

    <color=#66d9ef>for</color> <color=#f8f8f2>(</color><color=#f8f8f2>Record</color> <color=#f8f8f2>record</color> <color=#f8f8f2>:</color> <color=#f8f8f2>remoteDiffs</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f92672>!</color><color=#f8f8f2>localDiffs</color><color=#f8f8f2>.</color><color=#a6e22e>contains</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>))</color> <color=#f8f8f2>{</color>
        <color=#f8f8f2>printRecord</color><color=#f8f8f2>(</color><color=#f8f8f2>record</color><color=#f8f8f2>,</color> <color=#e6db74>"local"</color><color=#f8f8f2>,</color> <color=#66d9ef>true</color><color=#f8f8f2>);</color>
      <color=#f8f8f2>}</color>
    <color=#f8f8f2>}</color>
    <color=#f8f8f2>System</color><color=#f8f8f2>.</color><color=#a6e22e>err</color><color=#f8f8f2>.</color><color=#a6e22e>println</color><color=#f8f8f2>(</color><color=#e6db74>"************************************************"</color><color=#f8f8f2>);</color>
  <color=#f8f8f2>}</color>

  <color=#75715e>/*</color>
<color=#75715e>   * Get the LSN that the cursor currently points to, there are two cases</color>
<color=#75715e>   * that a record doesn't have a VLSN:</color>
<color=#75715e>   * 1. compare between two local databases.</color>
<color=#75715e>   * 2. compare between two converted environments.</color>
<color=#75715e>   *</color>
<color=#75715e>   * In the above two cases, we actually return NULL_VLSN instead of null, so</color>
<color=#75715e>   * that the message doesn't complain about a null value.</color>
<color=#75715e>   */</color>
  <color=#66d9ef>private</color> <color=#66d9ef>static</color> <color=#f8f8f2>VLSN</color> <color=#a6e22e>getVLSN</color><color=#f8f8f2>(</color><color=#f8f8f2>Cursor</color> <color=#f8f8f2>cursor</color><color=#f8f8f2>,</color> <color=#f8f8f2>LogManager</color> <color=#f8f8f2>logManager</color><color=#f8f8f2>)</color> <color=#66d9ef>throws</color> <color=#f8f8f2>Exception</color> <color=#f8f8f2>{</color>

    <color=#f8f8f2>CursorImpl</color> <color=#f8f8f2>cursorImpl</color> <color=#f92672>=</color> <color=#f8f8f2>DbInternal</color><color=#f8f8f2>.</color><color=#a6e22e>getCursorImpl</color><color=#f8f8f2>(</color><color=#f8f8f2>cursor</color><color=#f8f8f2>);</color>
    <color=#f8f8f2>cursorImpl</color><color=#f8f8f2>.</color><color=#a6e22e>latchBIN</color><color=#f8f8f2>();</color>
    <color=#66d9ef>final</color> <color=#66d9ef>long</color> <color=#f8f8f2>lsn</color> <color=#f92672>=</color> <color=#f8f8f2>cursorImpl</color><color=#f8f8f2>.</color><color=#a6e22e>getCurrentLsn</color><color=#f8f8f2>();</color>
    <color=#f8f8f2>cursorImpl</color><color=#f8f8f2>.</color><color=#a6e22e>releaseBIN</color><color=#f8f8f2>();</color>

    <color=#f8f8f2>WholeEntry</color> <color=#f8f8f2>entry</color> <color=#f92672>=</color> <color=#f8f8f2>logManager</color><color=#f8f8f2>.</color><color=#a6e22e>getLogEntryAllowInvisible</color><color=#f8f8f2>(</color><color=#f8f8f2>lsn</color><color=#f8f8f2>);</color>

    <color=#f8f8f2>VLSN</color> <color=#f8f8f2>vlsn</color> <color=#f92672>=</color> <color=#f8f8f2>entry</color><color=#f8f8f2>.</color><color=#a6e22e>getHeader</color><color=#f8f8f2>().</color><color=#a6e22e>getVLSN</color><color=#f8f8f2>();</color>
    <color=#66d9ef>if</color> <color=#f8f8f2>(</color><color=#f8f8f2>vlsn</color> <color=#f92672>==</color> <color=#66d9ef>null</color><color=#f8f8f2>)</color> <color=#f8f8f2>{</color>
      <color=#f8f8f2>vlsn</color> <color=#f92672>=</color> <color=#f8f8f2>VLSN</color><color=#f8f8f2>.</color><color=#a6e22e>NULL_VLSN</color><color=#f8f8f2>;</color>
    <color=#f8f8f2>}</color>

    <color=#66d9ef>return</color> <color=#f8f8f2>vlsn</color><color=#f8f8f2>;</color>
  <color=#f8f8f2>}</color>
<color=#f8f8f2>}</color>