<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">main.java.components.hash.algorithms</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Hash Function Blake2b </span>
<span class="cm"> * </span>
<span class="cm"> * Copyright (C) 2015  Axel von dem Bruch</span>
<span class="cm"> * </span>
<span class="cm"> * This library is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="cm"> * </span>
<span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * Lesser General Public License for more details.</span>
<span class="cm"> * </span>
<span class="cm"> * See:  https://www.gnu.org/licenses/lgpl-2.1.html</span>
<span class="cm"> * You should have received a copy of the GNU General Public License </span>
<span class="cm"> * along with this library.</span>
<span class="cm"> * </span>
<span class="cm"> * Note: A modified version of this class might be in future a part of </span>
<span class="cm"> * Bouncy Castle Crypto API</span>
<span class="cm"> * and will probably available under MIT-like license </span>
<span class="cm"> */</span>


<span class="cm">/*  The BLAKE2 cryptographic hash function was designed by Jean-</span>
<span class="cm">   Philippe Aumasson, Samuel Neves, Zooko Wilcox-O&#39;Hearn, and Christian</span>
<span class="cm">   Winnerlein.</span>
<span class="cm">   With a built-in keying mechanism BLAKE2 can be used instead of a HMAC construction.</span>
<span class="cm">   BLAKE2b is optimized for 64-bit platforms and produces digests of any size </span>
<span class="cm">   between 1 and 64 bytes.      </span>
<span class="cm">      Reference Implementation and Description can be found at: https://blake2.net/      </span>
<span class="cm">      Internet Draft: https://tools.ietf.org/html/draft-saarinen-blake2-02</span>
<span class="cm">      </span>
<span class="cm">   This implementation does not support the Tree Hashing Mode. </span>
<span class="cm">          </span>
<span class="cm">      </span>
<span class="cm">   Example code using this class:</span>
<span class="cm">      </span>
<span class="cm">      Blake2b b = new Blake2b(); // no key, no salt, no personalization</span>
<span class="cm">      b.update( anyByteArray1 );</span>
<span class="cm">      b.update( anyByteArray2 );</span>
<span class="cm">      byte[] hash = new byte[64];// full length of hash value</span>
<span class="cm">      b.doFinal(hash, 0); // result now holds the hash value (64 byte)</span>
<span class="cm">      </span>
<span class="cm">      Blake2b b2b = new Blake2b(); // no key, no salt, no personalization</span>
<span class="cm">      b2b2.update( anyByteArray );</span>
<span class="cm">      // store hash value in any byte array with length &gt; 64 + pos</span>
<span class="cm">      b2b.doFinal(result, pos); // result now holds the hash value (64 byte) at position pos</span>
<span class="cm">      </span>
<span class="cm">      Blake2b b2bK = new Blake2b( anyKeyAsByteArray );// key length 0 - 64 </span>
<span class="cm">      b2bK.update( anyByteArray );</span>
<span class="cm">      byte[] resultK = new byte[64];// full length of hash value</span>
<span class="cm">      b2bK.doFinal(resultK, 0); // resultK now holds the hash value</span>
<span class="cm">      </span>
<span class="cm">      Blake2b b2bX = new Blake2b(</span>
<span class="cm">            anyKeyAsByteArray, // 0 - 64 Byte or null</span>
<span class="cm">            outputLength, // 1 - 64</span>
<span class="cm">            anySaltAsByteArray, // exactly 16 Byte or null</span>
<span class="cm">            anyPersonalizationAsByteArray); // exactly 16 Byte or null</span>
<span class="cm">      b2bX.update( anyByteArray );</span>
<span class="cm">      byte[] resultX = new byte[outputLength];</span>
<span class="cm">      b2bX.doFinal(resultX, 0); // resultX now holds the hash value    </span>
<span class="cm">*/</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">main.java.components.hash.HashInterface</span><span class="p">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Blake2b</span> <span class="kd">implements</span> <span class="n">HashInterface</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="o">[]</span> <span class="n">blake2b_IV</span>  <span class="o">=</span> 
            <span class="c1">// Blake2b Initialization Vector: </span>
            <span class="c1">// Produced from the square root of primes 2, 3, 5, 7, 11, 13, 17, 19.</span>
            <span class="c1">// The same as SHA-512 IV.</span>
        <span class="p">{</span>
          <span class="mh">0x6a09e667f3bcc908L</span><span class="p">,</span> <span class="mh">0xbb67ae8584caa73bL</span><span class="p">,</span>
          <span class="mh">0x3c6ef372fe94f82bL</span><span class="p">,</span> <span class="mh">0xa54ff53a5f1d36f1L</span><span class="p">,</span>
          <span class="mh">0x510e527fade682d1L</span><span class="p">,</span> <span class="mh">0x9b05688c2b3e6c1fL</span><span class="p">,</span>
          <span class="mh">0x1f83d9abfb41bd6bL</span><span class="p">,</span> <span class="mh">0x5be0cd19137e2179L</span> 
        <span class="p">};</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[][]</span> <span class="n">blake2b_sigma</span> <span class="o">=</span> <span class="c1">// Message word permutations</span>
        <span class="p">{</span>
          <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span> <span class="p">}</span> <span class="p">,</span>
          <span class="p">{</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">}</span>
        <span class="p">};</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">rOUNDS</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// to use for Catenas H&#39;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">BLOCK_LENGTH_BYTES</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span><span class="c1">// bytes</span>
    
    <span class="c1">// General parameters:</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">digestLength</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="c1">// 1- 64 bytes </span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 0 - 64 bytes for keyed hashing for MAC</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">salt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//new byte[16];</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">personalization</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//new byte[16];</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">_vIndex</span><span class="p">;</span>
    
    <span class="c1">// Tree hashing parameters: </span>
    <span class="c1">// Because this class does not implement the Tree Hashing Mode,</span>
    <span class="c1">// these parameters can be treated as constants (see init() function)</span>
<span class="cm">/*  private int fanout = 1; // 0-255</span>
<span class="cm">    private int depth = 1; // 1 - 255</span>
<span class="cm">    private int leafLength= 0; </span>
<span class="cm">    private long nodeOffset = 0L;</span>
<span class="cm">    private int nodeDepth = 0; </span>
<span class="cm">    private int innerHashLength = 0; </span>
<span class="cm">*/</span>  
    
    <span class="c1">// whenever this buffer overflows, it will be processed </span>
    <span class="c1">// in the compress() function. </span>
    <span class="c1">// For performance issues, long messages will not use this buffer. </span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//new byte[BLOCK_LENGTH_BYTES];</span>
    <span class="c1">// Position of last inserted byte:</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bufferPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// a value from 0 up to 128</span>

    <span class="kd">private</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">internalState</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">;</span> <span class="c1">// In the Blake2b paper it is called: v</span>
    <span class="kd">private</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">chainValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// state vector, in the Blake2b paper it is called: h</span>
    
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span> <span class="c1">// holds last significant bits, counter (counts bytes)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span> <span class="c1">// counter: Length up to 2^128 are supported</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">f0</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span> <span class="c1">// finalization flag, for last block: ~0L</span>


    <span class="c1">// For Tree Hashing Mode, not used here:</span>
<span class="c1">//  private long f1 = 0L; // finalization flag, for last node: ~0L </span>
    
    <span class="kd">public</span> <span class="nf">Blake2b</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">BLOCK_LENGTH_BYTES</span><span class="o">]</span><span class="p">;</span>
        <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">digestLength</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="n">init</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">Blake2b</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">BLOCK_LENGTH_BYTES</span><span class="o">]</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Keys &gt; 64 are not supported&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">keyLength</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
            <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
            <span class="n">bufferPos</span> <span class="o">=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span> <span class="c1">// zero padding</span>
        <span class="p">}</span> 
        <span class="n">digestLength</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="n">init</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="nf">Blake2b</span><span class="p">(</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="p">,</span> 
            <span class="kt">int</span> <span class="n">_digestLength</span><span class="p">,</span> 
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">_salt</span><span class="p">,</span> 
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">_personalization</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">BLOCK_LENGTH_BYTES</span><span class="o">]</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_digestLength</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">digestLength</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Invalid digest length (required: 1 - 64)&quot;</span><span class="p">);</span>     
        <span class="p">}</span>
        <span class="n">digestLength</span> <span class="o">=</span> <span class="n">_digestLength</span><span class="p">;</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">_salt</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_salt</span><span class="p">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;salt length must be exactly 16 bytes&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">salt</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">;</span>
            <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">_salt</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">salt</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">_salt</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_personalization</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_personalization</span><span class="p">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;personalization length must be exactly 16 bytes&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">personalization</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">;</span>
            <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">_personalization</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">personalization</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">_personalization</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="p">}</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Keys &gt; 64 are not supported&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">keyLength</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
            <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
            <span class="n">bufferPos</span> <span class="o">=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span> <span class="c1">// zero padding</span>
        <span class="p">}</span> 
        <span class="n">init</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="c1">// initialize chainValue</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">chainValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="n">chainValue</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="p">;</span>

            <span class="n">chainValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">^</span> <span class="p">(</span> <span class="n">digestLength</span> <span class="o">|</span> <span class="p">(</span><span class="n">keyLength</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1010000</span><span class="p">);</span>
                <span class="c1">// 0x1010000 = ((fanout &lt;&lt; 16) | (depth &lt;&lt; 24) | (leafLength &lt;&lt; 32)); </span>
                <span class="c1">// with fanout = 1; depth = 0; leafLength = 0;</span>
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span><span class="c1">// ^ nodeOffset; with nodeOffset = 0;</span>
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span><span class="c1">// ^ ( nodeDepth | (innerHashLength &lt;&lt; 8) );</span>
            <span class="c1">// with nodeDepth = 0; innerHashLength = 0;</span>
            
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">;</span>
            
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">;</span>
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">salt</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">chainValue</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">bytes2long</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                <span class="n">chainValue</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">bytes2long</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
            <span class="p">}</span>
            
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span><span class="p">;</span>
            <span class="n">chainValue</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">personalization</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">chainValue</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">bytes2long</span><span class="p">(</span><span class="n">personalization</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                <span class="n">chainValue</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">bytes2long</span><span class="p">(</span><span class="n">personalization</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>              
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initializeInternalState</span><span class="p">(){</span>
        
        <span class="c1">// initialize v:</span>
        <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">chainValue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">internalState</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chainValue</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">blake2b_IV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">internalState</span><span class="p">,</span> <span class="n">chainValue</span><span class="p">.</span><span class="na">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="n">internalState</span><span class="o">[</span><span class="mi">12</span><span class="o">]</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">^</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">;</span>
        <span class="n">internalState</span><span class="o">[</span><span class="mi">13</span><span class="o">]</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">^</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span><span class="p">;</span>
        <span class="n">internalState</span><span class="o">[</span><span class="mi">14</span><span class="o">]</span> <span class="o">=</span> <span class="n">f0</span> <span class="o">^</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span><span class="p">;</span>
        <span class="n">internalState</span><span class="o">[</span><span class="mi">15</span><span class="o">]</span> <span class="o">=</span> <span class="n">blake2b_IV</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span><span class="p">;</span><span class="c1">// ^ f1 with f1 = 0</span>
    <span class="p">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Processes the given message</span>
<span class="cm">     * </span>
<span class="cm">     * @param message</span>
<span class="cm">     *            byte array containing the message to be processed</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Processes one single byte</span>
<span class="cm">     * </span>
<span class="cm">     * @param b</span>
<span class="cm">     *            single byte to be processed</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">byte</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="kt">int</span> <span class="n">remainingLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// left bytes of buffer</span>

        <span class="c1">// process the buffer if full else add to buffer:   </span>
        <span class="n">remainingLength</span> <span class="o">=</span> <span class="n">BLOCK_LENGTH_BYTES</span> <span class="o">-</span> <span class="n">bufferPos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">remainingLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// full buffer </span>
            <span class="n">t0</span> <span class="o">+=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if message &gt; 2^64</span>
                <span class="n">t1</span><span class="o">++</span><span class="p">;</span>   
            <span class="p">}</span>
            <span class="n">compress</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="n">Arrays</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>  <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span><span class="c1">// clear buffer</span>
            <span class="n">buffer</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="n">bufferPos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">buffer</span><span class="o">[</span><span class="n">bufferPos</span><span class="o">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="n">bufferPos</span> <span class="o">++</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Processes a number of bytes of the given message </span>
<span class="cm">     * from a start position up to offset+len</span>
<span class="cm">     * </span>
<span class="cm">     * @param message</span>
<span class="cm">     *            byte array containing the message to be processed</span>
<span class="cm">     * @param offset</span>
<span class="cm">     *            position of message to start from</span>
<span class="cm">     * @param len</span>
<span class="cm">     *            number of bytes to be processed.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        
        <span class="kt">int</span> <span class="n">remainingLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// left bytes of buffer</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">bufferPos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// commenced, incomplete buffer</span>

            <span class="c1">// complete the buffer: </span>
            <span class="n">remainingLength</span> <span class="o">=</span> <span class="n">BLOCK_LENGTH_BYTES</span> <span class="o">-</span> <span class="n">bufferPos</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">remainingLength</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// full buffer + at least 1 byte</span>
                <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufferPos</span><span class="p">,</span> 
                        <span class="n">remainingLength</span><span class="p">);</span>
                <span class="n">t0</span> <span class="o">+=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if message &gt; 2^64</span>
                    <span class="n">t1</span><span class="o">++</span><span class="p">;</span>   
                <span class="p">}</span>
                <span class="n">compress</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                
                <span class="n">bufferPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">Arrays</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>  <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span><span class="c1">// clear buffer              </span>
                
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufferPos</span><span class="p">,</span> 
                        <span class="n">len</span><span class="p">);</span>
                <span class="n">bufferPos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>   
        <span class="c1">// process blocks except last block (also if last block is full)</span>
        <span class="kt">int</span> <span class="n">messagePos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">blockWiseLastPos</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span> <span class="n">messagePos</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">remainingLength</span><span class="p">;</span> <span class="n">messagePos</span> <span class="o">&lt;</span> <span class="n">blockWiseLastPos</span><span class="p">;</span> <span class="n">messagePos</span> <span class="o">+=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// block wise 128 bytes</span>
            <span class="c1">// without buffer:</span>
            <span class="n">t0</span> <span class="o">+=</span> <span class="n">BLOCK_LENGTH_BYTES</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">t1</span><span class="o">++</span><span class="p">;</span>   
            <span class="p">}</span>
            <span class="n">compress</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">messagePos</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//fill the buffer with left bytes, this might be a full block</span>
        <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">messagePos</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">messagePos</span><span class="p">);</span>   
        <span class="n">bufferPos</span> <span class="o">+=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">messagePos</span><span class="p">;</span>     
    <span class="p">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Calculates the final digest value</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">doFinal</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">digestLength</span><span class="o">]</span><span class="p">;</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFFFL</span><span class="p">;</span>
        <span class="n">t0</span> <span class="o">+=</span> <span class="n">bufferPos</span><span class="p">;</span>
        <span class="c1">// bufferPos may be &lt; 128, so (t0 == 0) does not work </span>
        <span class="c1">// for  2^64 &lt; message length &gt; 2^64 - 127</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bufferPos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">t1</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">compress</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">bufferPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chainValue</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">long2bytes</span><span class="p">(</span><span class="n">chainValue</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">keyLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">reset</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    
    
    <span class="cm">/**</span>
<span class="cm">     * Reset the hash function to use again after doFinal().</span>
<span class="cm">     * This will not work for keyed digests. </span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bufferPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="p">;</span>
        <span class="n">Arrays</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>  <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span><span class="c1">// Holds eventually the key if input is null</span>
        <span class="n">Arrays</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">chainValue</span><span class="p">,</span> <span class="mi">0</span><span class="n">L</span><span class="p">);</span>    
        <span class="n">Arrays</span><span class="p">.</span><span class="na">fill</span><span class="p">(</span><span class="n">internalState</span><span class="p">,</span> <span class="mi">0</span><span class="n">L</span><span class="p">);</span>
        <span class="n">chainValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">keyLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Can not reset keyed Digest&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">init</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">compress</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">messagePos</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">initializeInternalState</span><span class="p">();</span>
        
        <span class="kt">long</span><span class="o">[]</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">m</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">bytes2long</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">messagePos</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">round</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">round</span> <span class="o">&lt;</span> <span class="n">rOUNDS</span><span class="p">;</span> <span class="n">round</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="c1">// G apply to columns of internalState:m[blake2b_sigma[round][2 * blockPos]] /+1</span>
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">0</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">1</span><span class="o">]]</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span> 
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">2</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">3</span><span class="o">]]</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">13</span><span class="p">);</span> 
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">4</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">5</span><span class="o">]]</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span> 
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">6</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">7</span><span class="o">]]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> 
            <span class="c1">// G apply to diagonals of internalState:</span>
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">8</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">9</span><span class="o">]]</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span> 
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">10</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">11</span><span class="o">]]</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">12</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">13</span><span class="o">]]</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">13</span><span class="p">);</span>
            <span class="n">G</span><span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">14</span><span class="o">]]</span><span class="p">,</span> <span class="n">m</span><span class="o">[</span><span class="n">blake2b_sigma</span><span class="o">[</span><span class="n">round</span><span class="o">][</span><span class="mi">15</span><span class="o">]]</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// update chain values: </span>
        <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">chainValue</span><span class="o">[</span><span class="n">offset</span><span class="o">]</span> <span class="o">=</span> <span class="n">chainValue</span><span class="o">[</span><span class="n">offset</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">offset</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="o">]</span><span class="p">;</span>    
        <span class="p">}</span>
    <span class="p">}</span>
    

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">G</span><span class="p">(</span><span class="kt">long</span> <span class="n">m1</span><span class="p">,</span> <span class="kt">long</span> <span class="n">m2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posA</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posB</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posC</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posD</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span> <span class="o">=</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span> <span class="o">+</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">+</span> <span class="n">m1</span><span class="p">;</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span> <span class="o">=</span> <span class="n">rotr64</span><span class="p">(</span><span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span> <span class="o">=</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span> <span class="o">+</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span><span class="p">;</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">=</span> <span class="n">rotr64</span><span class="p">(</span><span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span> <span class="c1">// replaces 25 of BLAKE</span>
        <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span> <span class="o">=</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span> <span class="o">+</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">+</span> <span class="n">m2</span><span class="p">;</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span> <span class="o">=</span> <span class="n">rotr64</span><span class="p">(</span><span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posA</span><span class="o">]</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span> <span class="o">=</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span> <span class="o">+</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posD</span><span class="o">]</span><span class="p">;</span> 
        <span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">=</span> <span class="n">rotr64</span><span class="p">(</span><span class="n">internalState</span><span class="o">[</span><span class="n">posB</span><span class="o">]</span> <span class="o">^</span> <span class="n">internalState</span><span class="o">[</span><span class="n">posC</span><span class="o">]</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span> <span class="c1">// replaces 11 of BLAKE</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kt">long</span> <span class="nf">rotr64</span><span class="p">(</span><span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rot</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">rot</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">rot</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">(){</span>
        <span class="k">return</span> <span class="s">&quot;Blake2b&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// convert one long value in byte array</span>
    <span class="c1">// little-endian byte order!</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">long2bytes</span><span class="p">(</span><span class="kt">long</span> <span class="n">longValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="p">{</span>         
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="n">longValue</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longValue</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)};</span>
    <span class="p">}</span>
    <span class="c1">// little-endian byte order!</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">bytes2long</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">byteArray</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
          
          <span class="k">return</span> <span class="p">(</span>                
                  <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">6</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">byteArray</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">7</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>                                  
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVertexIndex</span><span class="p">(</span><span class="kt">int</span> <span class="n">vIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_vIndex</span> <span class="o">=</span> <span class="n">vIndex</span><span class="p">;</span>   
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOutputSize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">digestLength</span><span class="p">;</span>
    <span class="p">}</span>   
<span class="p">}</span>
</pre></div>
